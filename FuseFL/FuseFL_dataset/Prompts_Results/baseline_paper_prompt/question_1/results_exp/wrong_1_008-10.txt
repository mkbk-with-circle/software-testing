Loop iteration doesn't process the last element