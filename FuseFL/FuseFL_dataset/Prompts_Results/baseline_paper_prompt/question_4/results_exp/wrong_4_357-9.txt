Appending elements inside the loop leads to incorrect results