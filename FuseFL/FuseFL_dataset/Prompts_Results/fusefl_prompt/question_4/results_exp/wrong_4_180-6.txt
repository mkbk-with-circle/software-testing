The loop structure seems correct and doesn't appear to be the cause of the incorrect results.